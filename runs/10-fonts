#!/usr/bin/env bash

readonly RELEASE_VERSION="v3.4.0"
readonly NERD_FONTS_GIT="https://github.com/ryanoasis/nerd-fonts/releases/download"

declare -a FONT_ZIPS=(
  "BitstreamVeraSansMono.zip"
  "FiraMono.zip"
)

OS="${OSTYPE:-}"
if [[ "$OS" == darwin* ]]; then
  FONTS_DIR="${HOME}/Library/Fonts"
else
  FONTS_DIR="${HOME}/.local/share/fonts"
fi
readonly FONTS_DIR

validate_fonts_installed() {
  for zipname in "${FONT_ZIPS[@]}"; do
    local base="${zipname%.zip}"           # e.g., FiraMono
    if ! find "$FONTS_DIR" -type f -iname "${base}*" -print -quit >/dev/null 2>&1; then
      return 1
    fi
  done
  return 0
}

mkdir -p "$FONTS_DIR"
if validate_fonts_installed; then
  printf "Fonts already installed in: $FONTS_DIR"
  exit 0
fi

TMPDIR="$(mktemp -d 2>/dev/null || mktemp -d -t nerdfonts)"
trap 'rm -rf "$TMPDIR"' EXIT
printf "Downloading and installing Nerd Fonts ${RELEASE_VERSION} to $FONTS_DIR ..."
for zipname in "${FONT_ZIPS[@]}"; do
  url="${NERD_FONTS_GIT}/${RELEASE_VERSION}/${zipname}"
  out="${TMPDIR}/${zipname}"
  download "$url" "$out"
  unzip -oq "$out" -d "$FONTS_DIR"
done

if [[ "$OS" == darwin* ]]; then
  # macOS picks up fonts placed in ~/Library/Fonts automatically
  log "macOS: fonts available immediately."
else
  if have fc-cache; then
    fc-cache -fv >/dev/null || true
    printf "Linux: font cache refreshed."
  else
    log "Linux: 'fc-cache' not found; fonts should still work, but you may need to install 'fontconfig' to refresh cache."
  fi
fi

