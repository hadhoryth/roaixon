#!/usr/bin/env bash
set -euo pipefail

log() {
  printf "[%s] %s\n" "$(date '+%H:%M:%S')" "$*"
}

[[ "${OSTYPE:-}" != darwin* ]] && sudo apt update

if [[ "${OSTYPE:-}" == darwin* ]]; then
  if ! command -v nvim &>/dev/null; then
    log "Installing neovim"
    brew install neovim
  fi
else
  if ! command -v nvim &>/dev/null; then
    log "Installing neovim build dependencies"
    sudo apt install -y cmake gettext lua5.1 liblua5.1-0-dev build-essential git ninja-build

    nvim_dir="$HOME/personal/nvim"
    mkdir -p "$(dirname "$nvim_dir")"

    if [[ ! -d "$nvim_dir" ]]; then
      log "Cloning neovim"
      git clone https://github.com/neovim/neovim.git "$nvim_dir" 2>/dev/null || true
    fi

    log "Building neovim"
    (cd "$nvim_dir" && git checkout stable && make CMAKE_BUILD_TYPE=RelWithDebInfo -j"$(nproc)" && sudo make install)
  fi
fi

log "Done"
