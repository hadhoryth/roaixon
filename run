#!/usr/bin/env bash

DRY_RUN=0

while [[ $# -gt 0 ]]; do
  case "$1" in
    --dry|-n) DRY_RUN=1; shift ;;
    *) echo "Unknown option: $1"; exit 1 ;;
  esac
done

log() { printf '%s\n' "$*"; }
dry() { [[ $DRY_RUN -eq 1 ]]; }
run() { dry && printf '[DRY_RUN] %s\n' "$*" || "$@"; }


script_dir="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"

copy_config() {
  local config_dir="$HOME/.config/"
  local dev_config_dir="$script_dir/env/.config"

  run mkdir -p "$config_dir"
  run cp -r "$dev_config_dir" "$config_dir"
}

copy_zsh_config() {
  local dest_dir="$HOME/personal"
  local src_dir="$script_dir/env"

  run mkdir -p "$dest_dir"
  run find "$src_dir" -type f -name ".*zsh*" -exec cp {} "$dest_dir" \; 
}

run_executables() {
  local runs_dir="$script_dir/runs"

  if [[ -d "$runs_dir" ]]; then
    for s in "$runs_dir"/*; do
      [[ -f "$s" && -x "$s" ]] || continue
      run "$s"
    done
  else
    log "No runs directory at $runs_dir (skipping)"
  fi
}

run_executables
copy_config
copy_zsh_config

if ! dry; then
  printf '\nActivate environment with:\n'
  printf '  source "%s/personal/.zshrc"\n' "$HOME"
fi
